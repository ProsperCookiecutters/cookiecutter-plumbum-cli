# Author: {{cookiecutter.author_name}}
# Email: {{cookiecutter.author_email}}
# GENERATED BY: cookiecutter-plumbum-cli:{{cookiecutter.template_version}} {% now 'utc', '%Y-%m-%d' %}
PYPI_REPOSITORY_URL=
BLACK_ARGS=
TOX_ENVLIST={{cookiecutter.tox_pyenvs}}
VENV_FILE=.venv
VERSION=1.0.0
WHICH_PYTHON=$(VENV_FILE)/bin/python
WHICH_PIP=$(VENV_FILE)/bin/pip

.PHONY: clean
clean:
	-@rm -rf $(VENV_FILE)
	-@rm -rf dist
	-@rm -rf .eggs
	-@rm -rf *.egg-info
	-@find . -type d -maxdepth 3 -name "__pycache__" -print0 | xargs -0 rm -rv
	-@rm -rf .pytest_cache
	-@rm .coverage
	-@rm -rf .tox
	-@rm install
	-@rm test-install

$(VENV_FILE): setup.py 
	@virtualenv $(VENV_FILE) -p python3
	@touch $@
$(VENV_FILE)/bin/wheel: $(VENV_FILE)
	@$(WHICH_PIP) install wheel
$(VENV_FILE)/bin/black: $(VENV_FILE)
	@$(WHICH_PIP) install black
$(VENV_FILE)/bin/twine: $(VENV_FILE)
	@$(WHICH_PIP) install twine
$(VENV_FILE)/bin/sphinx: $(VENV_FILE)
	@$(WHICH_PIP) install sphinx
$(VENV_FILE)/bin/tox: $(VENV_FILE)
	@$(WHICH_PIP) install tox

install: $(VENV_FILE) setup.py
	@$(WHICH_PIP) install -e .
	@touch $@

test-install: $(VENV_FILE) setup.py
	@$(WHICH_PIP) install -e .[dev]
	@touch $@

.PHONY: test
test: $(VENV_FILE)/bin/tox
	@tox -e $(TOX_ENVLIST)

.PHONY: black
black: $(VENV_FILE)/bin/black
	@black -S $(BLACK_ARGS)

dist/{{cookiecutter.project_name}}-$(VERSION).tar.gz: $(VENV_FILE) 
	@$(WHICH_PYTHON) setup.py sdist

dist/{{cookiecutter.project_name|replace('-', '_')}}-$(VERSION)*.whl: $(VENV_FILE) $(VENV_FILE)/bin/wheel
	@$(WHICH_PYTHON) setup.py bdist_wheel

.PHONY: build
build: dist/{{cookiecutter.project_name}}-$(VERSION).tar.gz dist/{{cookiecutter.project_name|replace('-', '_')}}-$(VERSION)*.whl

.PHONY: docs
docs: $(VENV_FILE)/bin/sphinx
	@sphinx docs/

.PHONY: register
register: $(VENV_FILE)/bin/twine build
	@twine register \
		--repository-url=$(PYPI_REPOSITORY_URL) \
		-u $(PYPI_USERNAME) \
		-p $(PYPI_PASSWORD) \
		dist/ \
		$(PYPI_EXTRA_ARGS)

.PHONY: upload
upload: $(VENV_FILE)/bin/twine build
	@twine upload \
		--repository-url=$(PYPI_REPOSITORY_URL) \
		-u $(PYPI_USERNAME) \
		-p $(PYPI_PASSWORD) \
		dist/ \
		$(PYPI_EXTRA_ARGS)

.PHONY: check
check: $(VENV_FILE)/bin/twine build
	@twine check dist/*
